name: CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Configure AWS ----
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }}

      # ---- Terraform Plan ----
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.4

      - run: terraform -chdir=terraform init
      - run: terraform -chdir=terraform plan

      # ---- Docker Build & Push ----
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/simple-app:latest ./app
          docker push ${{ secrets.DOCKER_USERNAME }}/simple-app:latest

      # ---- Deploy to Kubernetes ----
      - name: Deploy manifests
        run: kubectl apply -k Project/k8s/

      # ---- Rollout Verification ----
      - name: Rollout status
        run: kubectl rollout status deployment/simple-app -n demo

      # ---- Smoke Test ----
      - name: Smoke test /health
        run: |
          SERVICE_URL=$(kubectl get svc simple-app-service -n demo -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "Testing: http://$SERVICE_URL/health"
          curl -f http://$SERVICE_URL/health
